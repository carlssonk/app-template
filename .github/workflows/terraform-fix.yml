name: Terraform Fix Operations

on:
  workflow_dispatch:
    inputs:
      operation:
        type: choice
        description: "Operation to perform"
        required: true
        options:
          - unlock
          - import
        default: unlock
      environment:
        type: choice
        description: "Target environment"
        required: true
        options:
          - dev
          - staging
          - production
        default: staging
      terraform_directory:
        type: choice
        description: "Terraform directory"
        required: true
        options:
          - app-staging-production
          - app-global
          - devops
        default: app-staging-production
      lock_id:
        type: string
        description: "Lock ID (required for unlock operation)"
        required: false
      import_address:
        type: string
        description: "Terraform resource address (required for import, e.g., aws_s3_bucket.example)"
        required: false
      import_id:
        type: string
        description: "AWS resource ID (required for import, e.g., bucket-name or arn:aws:...)"
        required: false

concurrency:
  group: terraform-fix-${{ inputs.environment }}-${{ inputs.terraform_directory }}
  cancel-in-progress: false

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    steps:
      - name: Validate unlock inputs
        if: inputs.operation == 'unlock'
        run: |
          if [ -z "${{ inputs.lock_id }}" ]; then
            echo "Error: lock_id is required for unlock operation"
            exit 1
          fi
          echo "✓ Unlock operation validated"

      - name: Validate import inputs
        if: inputs.operation == 'import'
        run: |
          if [ -z "${{ inputs.import_address }}" ] || [ -z "${{ inputs.import_id }}" ]; then
            echo "Error: import_address and import_id are required for import operation"
            exit 1
          fi
          echo "✓ Import operation validated"

  confirm-operation:
    name: Confirm Operation
    needs: validate-inputs
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    environment:
      name: terraform-fix-approval
    steps:
      - name: Display operation details
        run: |
          echo "Operation: ${{ inputs.operation }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Terraform Directory: ${{ inputs.terraform_directory }}"
          if [ "${{ inputs.operation }}" == "unlock" ]; then
            echo "Lock ID: ${{ inputs.lock_id }}"
          elif [ "${{ inputs.operation }}" == "import" ]; then
            echo "Resource Address: ${{ inputs.import_address }}"
            echo "Resource ID: ${{ inputs.import_id }}"
          fi
          echo ""
          echo "Waiting for manual approval..."

  execute-operation:
    name: Execute ${{ inputs.operation }} - ${{ inputs.environment }}
    needs: confirm-operation
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Terraform directory path
        id: set-path
        run: |
          case "${{ inputs.terraform_directory }}" in
            "app-staging-production")
              echo "tf_path=./terraform/app/environments/staging-and-production" >> $GITHUB_OUTPUT
              echo "state_key=terraform.tfstate" >> $GITHUB_OUTPUT
              ;;
            "app-global")
              echo "tf_path=./terraform/app/global" >> $GITHUB_OUTPUT
              echo "state_key=global.tfstate" >> $GITHUB_OUTPUT
              ;;
            "devops")
              echo "tf_path=./terraform/devops" >> $GITHUB_OUTPUT
              echo "state_key=devops.tfstate" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Set AWS Account ID
        id: set-account
        run: |
          case "${{ inputs.environment }}" in
            "dev")
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_DEV }}" >> $GITHUB_OUTPUT
              ;;
            "staging")
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_STAGING }}" >> $GITHUB_OUTPUT
              ;;
            "production")
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_PRODUCTION }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.set-account.outputs.account_id }}:role/github-actions-role
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.9.0

      - name: Terraform Init
        working-directory: ${{ steps.set-path.outputs.tf_path }}
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.AWS_REGION }}-${{ steps.set-account.outputs.account_id }}-terraform-state" \
            -backend-config="key=${{ steps.set-path.outputs.state_key }}" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.AWS_REGION }}-${{ steps.set-account.outputs.account_id }}-terraform-state-lock"

      - name: Unlock State
        if: inputs.operation == 'unlock'
        working-directory: ${{ steps.set-path.outputs.tf_path }}
        run: |
          echo "Unlocking state with Lock ID: ${{ inputs.lock_id }}"
          terraform force-unlock -force "${{ inputs.lock_id }}"
          echo "✓ State unlocked successfully"

      - name: Import Resource
        if: inputs.operation == 'import'
        working-directory: ${{ steps.set-path.outputs.tf_path }}
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}
          TF_VAR_runs_on_license_key: ${{ secrets.RUNS_ON_LICENSE_KEY }}
        run: |
          echo "Importing resource:"
          echo "  Address: ${{ inputs.import_address }}"
          echo "  ID: ${{ inputs.import_id }}"
          terraform import "${{ inputs.import_address }}" "${{ inputs.import_id }}"
          echo "✓ Resource imported successfully"

      - name: Verify State
        working-directory: ${{ steps.set-path.outputs.tf_path }}
        run: |
          echo "Verifying state..."
          terraform state list
          echo "✓ State verification complete"
