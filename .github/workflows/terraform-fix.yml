name: Terraform Fix Operations

on:
  workflow_dispatch:
    inputs:
      operation:
        type: choice
        description: "Operation to perform"
        required: true
        options:
          - unlock
          - import
        default: unlock
      environment:
        type: choice
        description: "Target environment"
        required: true
        options:
          - dev
          - staging
          - production
        default: staging
      terraform_directory:
        type: choice
        description: "Terraform directory"
        required: true
        options:
          - app-staging-production
          - app-global
          - devops
        default: app-staging-production
      lock_id:
        type: string
        description: "Lock ID (required for unlock operation)"
        required: false
      import_address:
        type: string
        description: "Terraform resource address (required for import, e.g., aws_s3_bucket.example)"
        required: false
      import_id:
        type: string
        description: "AWS resource ID (required for import, e.g., bucket-name or arn:aws:...)"
        required: false

concurrency:
  group: terraform-fix-${{ inputs.environment }}
  cancel-in-progress: false

env:
  TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  TF_VAR_cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    steps:
      - name: Validate unlock inputs
        if: inputs.operation == 'unlock'
        run: |
          if [ -z "${{ inputs.lock_id }}" ]; then
            echo "Error: lock_id is required for unlock operation"
            exit 1
          fi
          echo "✓ Unlock operation validated"

      - name: Validate import inputs
        if: inputs.operation == 'import'
        run: |
          if [ -z "${{ inputs.import_address }}" ] || [ -z "${{ inputs.import_id }}" ]; then
            echo "Error: import_address and import_id are required for import operation"
            exit 1
          fi
          echo "✓ Import operation validated"

  fix-dev:
    needs: validate-confirmation
    if: inputs.environment == 'dev'
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Destroy Infrastructure
        uses: carlssonk/terraform-modules/.github/actions/destroy@main
        with:
          environment: dev
          aws_region: ${{ vars.AWS_REGION }}
          aws_account_id: ${{ vars.AWS_ACCOUNT_ID_DEV }}
          tf_root_directory: ./terraform/app/environments/dev
          operation: ${{ inputs.operation }}
          lock_id: ${{ inputs.lock_id }}
          import_address: ${{ inputs.import_address }}
          import_id: ${{ inputs.import_id }}

  fix-staging:
    needs: validate-confirmation
    if: inputs.environment == 'staging'
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Destroy Infrastructure
        uses: carlssonk/terraform-modules/.github/actions/destroy@main
        with:
          environment: staging
          aws_region: ${{ vars.AWS_REGION }}
          aws_account_id: ${{ vars.AWS_ACCOUNT_ID_STAGING }}
          tf_root_directory: ./terraform/app/environments/staging-and-production
          operation: ${{ inputs.operation }}
          lock_id: ${{ inputs.lock_id }}
          import_address: ${{ inputs.import_address }}
          import_id: ${{ inputs.import_id }}

  fix-production:
    needs: validate-confirmation
    if: inputs.environment == 'production'
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Destroy Infrastructure
        uses: carlssonk/terraform-modules/.github/actions/destroy@main
        with:
          environment: production
          aws_region: ${{ vars.AWS_REGION }}
          aws_account_id: ${{ vars.AWS_ACCOUNT_ID_PRODUCTION }}
          tf_root_directory: ./terraform/app/environments/staging-and-production
          state_key: terraform.tfstate
          operation: ${{ inputs.operation }}
          lock_id: ${{ inputs.lock_id }}
          import_address: ${{ inputs.import_address }}
          import_id: ${{ inputs.import_id }}

  fix-global:
    needs: validate-confirmation
    if: inputs.environment == 'production'
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Fix Infrastructure
        uses: carlssonk/terraform-modules/.github/actions/fix@main
        with:
          environment: production
          aws_region: ${{ vars.AWS_REGION }}
          aws_account_id: ${{ vars.AWS_ACCOUNT_ID_PRODUCTION }}
          tf_root_directory: ./terraform/app/global
          state_key: global.tfstate
          operation: ${{ inputs.operation }}
          lock_id: ${{ inputs.lock_id }}
          import_address: ${{ inputs.import_address }}
          import_id: ${{ inputs.import_id }}