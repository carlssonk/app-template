name: Destroy App Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Choose an environment to destroy"
        required: true
        options:
          - dev
          - staging
          - production
      confirmation:
        description: 'Type "DESTROY" to confirm infrastructure destruction'
        required: true
        type: string

concurrency:
  group: terraform-destroy-${{ inputs.environment }}
  cancel-in-progress: false

env:
  TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  validate-confirmation:
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    timeout-minutes: 5
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirmation }}" != "DESTROY" ]; then
            echo "❌ Confirmation failed. You must type 'DESTROY' (uppercase) to proceed."
            exit 1
          fi
          echo "✅ Confirmation validated"

  destroy-dev:
    needs: validate-confirmation
    if: inputs.environment == 'dev'
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Destroy Infrastructure
        uses: carlssonk/terraform-modules/.github/actions/destroy@main
        with:
          environment: dev
          aws_region: ${{ vars.AWS_REGION }}
          aws_account_id: ${{ vars.AWS_ACCOUNT_ID_DEV }}
          tf_root_directory: ./terraform/app/environments/dev

  destroy-staging:
    needs: validate-confirmation
    if: inputs.environment == 'staging'
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Destroy Infrastructure
        uses: carlssonk/terraform-modules/.github/actions/destroy@main
        with:
          environment: staging
          aws_region: ${{ vars.AWS_REGION }}
          aws_account_id: ${{ vars.AWS_ACCOUNT_ID_STAGING }}
          tf_root_directory: ./terraform/app/environments/staging-and-production

  destroy-production:
    needs: validate-confirmation
    if: inputs.environment == 'production'
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Destroy Infrastructure
        uses: carlssonk/terraform-modules/.github/actions/destroy@main
        with:
          environment: production
          aws_region: ${{ vars.AWS_REGION }}
          aws_account_id: ${{ vars.AWS_ACCOUNT_ID_PRODUCTION }}
          tf_root_directory: ./terraform/app/environments/staging-and-production
          state_key: terraform.tfstate

  destroy-global:
    needs: validate-confirmation
    if: inputs.environment == 'production'
    runs-on: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Destroy Infrastructure
        uses: carlssonk/terraform-modules/.github/actions/destroy@main
        with:
          environment: production
          aws_region: ${{ vars.AWS_REGION }}
          aws_account_id: ${{ vars.AWS_ACCOUNT_ID_PRODUCTION }}
          tf_root_directory: ./terraform/app/global
          state_key: global.tfstate