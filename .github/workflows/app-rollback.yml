name: Rollback App

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Environment to rollback"
        required: true
        options:
          - staging
          - production
      commit_hash:
        type: string
        description: "Optional: Specific commit hash to rollback to (short or full hash). Leave empty to rollback to previous release."
        required: false

concurrency:
  group: rollback-app-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  rollback-staging:
    if: inputs.environment == 'staging'
    uses: carlssonk/cicd-toolkit/.github/workflows/rollback-s3.yml@main
    with:
      environment: ${{ inputs.environment }}
      aws_region: ${{ vars.AWS_REGION }}
      aws_role_arn: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_STAGING }}:role/github-actions-role
      s3_bucket: ${{ vars.S3_BUCKET_STAGING }}
      target_commit_hash: ${{ inputs.commit_hash }}
      runner: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      id-token: write
      contents: read

  rollback-production:
    if: inputs.environment == 'production'
    uses: carlssonk/cicd-toolkit/.github/workflows/rollback-s3.yml@main
    with:
      environment: ${{ inputs.environment }}
      aws_region: ${{ vars.AWS_REGION }}
      aws_role_arn: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_PRODUCTION }}:role/github-actions-role
      s3_bucket: ${{ vars.S3_BUCKET_PRODUCTION }}
      target_commit_hash: ${{ inputs.commit_hash }}
      runner: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      id-token: write
      contents: read

  create-release-tag:
    needs: rollback-production
    if: needs.rollback-production.result == 'success'
    uses: carlssonk/cicd-toolkit/.github/workflows/create-release.yml@main
    with:
      environment: production
      commit_hash: ${{ needs.rollback-production.outputs.target_commit_hash }}
      tag_prefix: rollback
      generate_changelog: false
      runner: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    permissions:
      contents: write