name: Rollback App

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Environment to rollback"
        required: true
        options:
          - staging
          - production
      commit_hash:
        type: string
        description: "Optional: Specific commit hash to rollback to (short or full hash). Leave empty to rollback to previous release."
        required: false

concurrency:
  group: rollback-app-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  rollback:
    uses: carlssonk/cicd-toolkit/.github/workflows/rollback-s3.yml@main
    with:
      environment: ${{ inputs.environment }}
      aws_region: ${{ vars.AWS_REGION }}
      aws_role_arn: arn:aws:iam::${{ vars[format('AWS_ACCOUNT_ID_{0}', upper(inputs.environment))] }}:role/github-actions-role
      s3_bucket: ${{ vars[format('S3_BUCKET_{0}', upper(inputs.environment))] }}
      target_commit_hash: ${{ inputs.commit_hash }}
    permissions:
      id-token: write
      contents: read

  create-release-tag:
    needs: rollback
    if: needs.rollback.result == 'success'
    uses: carlssonk/cicd-toolkit/.github/workflows/create-release.yml@main
    with:
      environment: ${{ inputs.environment }}
      commit_hash: ${{ needs.rollback.outputs.target_commit_hash }}
      tag_prefix: rollback
      generate_changelog: false
    permissions:
      contents: write