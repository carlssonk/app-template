name: Rollback App

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Environment to rollback"
        required: true
        options:
          - production
          - staging
      commit_hash:
        type: string
        description: "Optional: Specific commit hash to rollback to (short or full hash). Leave empty to rollback to previous release."
        required: false

concurrency:
  group: rollback-app-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  rollback-staging:
    if: inputs.environment == 'staging'
    uses: carlssonk/cicd-toolkit/.github/workflows/rollback-s3.yml@main
    with:
      environment: ${{ inputs.environment }}
      aws_region: ${{ vars.AWS_REGION }}
      aws_role_arn: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_STAGING }}:role/github-actions-cicd-role
      s3_bucket: ${{ vars.S3_BUCKET_STAGING }}
      target_commit_hash: ${{ inputs.commit_hash }}
      enable_cloudflare_cache_purge: true
      cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}
      runner: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    permissions:
      id-token: write
      contents: read

  rollback-production:
    if: inputs.environment == 'production'
    uses: carlssonk/cicd-toolkit/.github/workflows/rollback-s3.yml@main
    with:
      environment: ${{ inputs.environment }}
      aws_region: ${{ vars.AWS_REGION }}
      aws_role_arn: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID_PRODUCTION }}:role/github-actions-cicd-role
      s3_bucket: ${{ vars.S3_BUCKET_PRODUCTION }}
      target_commit_hash: ${{ inputs.commit_hash }}
      enable_cloudflare_cache_purge: true
      cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}
      runner: runs-on=${{ github.run_id }}/runner=4cpu-linux-x64
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    permissions:
      id-token: write
      contents: read
