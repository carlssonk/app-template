name: Deploy Infrastructure

on:
  push:
    branches: [main, dev/*]
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-deploy.yml'
  pull_request:
    branches: [main, dev/*]
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Environment to deploy"
        required: true
        options:
          - dev
      action:
        type: choice
        description: "Action to perform"
        required: true
        default: plan
        options:
          - plan
          - apply

jobs:
  deployment-strategy:
    uses: ./.github/workflows/trunk-config.yml
    with:
      event_name: ${{ github.event_name }}
      branch: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
      workflow_dispatch_environment: ${{ github.event.inputs.environment }}
      workflow_dispatch_action: ${{ github.event.inputs.action }}

  approve-deployment:
    name: Approve Deployment
    runs-on: ubuntu-latest
    needs: deployment-strategy
    if: |
      needs.deployment-strategy.outputs.should_run == 'true' &&
      needs.deployment-strategy.outputs.action == 'apply' && 
      contains(fromJson(needs.deployment-strategy.outputs.environments), 'prod')
    environment:
      name: infra-approval
    steps:
      - name: Wait for manual approval
        run: echo "Deployment approved"

  deploy-dev:
    name: ${{ needs.deployment-strategy.outputs.action == 'plan' && 'Plan' || 'Deploy' }} Infrastructure - Development
    needs: deployment-strategy
    if: needs.deployment-strategy.outputs.should_run == 'true' && contains(fromJson(needs.deployment-strategy.outputs.environments), 'dev')
    permissions:
      contents: write
      id-token: write
    uses: carlssonk/terraform-modules/.github/workflows/deploy.yml@main
    with:
      environment: dev
      aws_region: ${{ vars.AWS_REGION }}
      organization: ${{ vars.ORGANIZATION }}
      aws_account_id: ${{ vars.AWS_ACCOUNT_ID_DEV }}
      tf_root_directory: ./terraform/environments/dev
      action: ${{ needs.deployment-strategy.outputs.action }}

  deploy-staging:
    name: ${{ needs.deployment-strategy.outputs.action == 'plan' && 'Plan' || 'Deploy' }} Infrastructure - Staging
    needs: deployment-strategy
    if: needs.deployment-strategy.outputs.should_run == 'true' && contains(fromJson(needs.deployment-strategy.outputs.environments), 'staging')
    permissions:
      contents: write
      id-token: write
    uses: carlssonk/terraform-modules/.github/workflows/deploy.yml@main
    with:
      environment: staging
      aws_region: ${{ vars.AWS_REGION }}
      organization: ${{ vars.ORGANIZATION }}
      aws_account_id: ${{ vars.AWS_ACCOUNT_ID_STAGING }}
      tf_root_directory: ./terraform/environments/staging-and-prod
      action: ${{ needs.deployment-strategy.outputs.action }}

  deploy-prod-environments:
    name: ${{ needs.deployment-strategy.outputs.action == 'plan' && 'Plan' || 'Deploy' }} ${{ matrix.name }}
    needs: [deployment-strategy, deploy-staging]
    if: |
      always() &&
      needs.deployment-strategy.outputs.should_run == 'true' &&
      contains(fromJson(needs.deployment-strategy.outputs.environments), 'prod') &&
      needs.deploy-staging.result == 'success' &&
      (needs.deployment-strategy.outputs.action == 'plan' || needs.approve-deployment.result == 'success')
    permissions:
      contents: write
      id-token: write
    strategy:
      matrix:
        include:
          - name: Infrastructure - Production
            tf_root_directory: ./terraform/environments/staging-and-prod
          - name: Cloudflare
            tf_root_directory: ./terraform/environments/cloudflare
    uses: carlssonk/terraform-modules/.github/workflows/deploy.yml@main
    with:
      environment: prod
      aws_region: ${{ vars.AWS_REGION }}
      organization: ${{ vars.ORGANIZATION }}
      aws_account_id: ${{ vars.AWS_ACCOUNT_ID_PROD }}
      tf_root_directory: ${{ matrix.tf_root_directory }}
      action: ${{ needs.deployment-strategy.outputs.action }}
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}